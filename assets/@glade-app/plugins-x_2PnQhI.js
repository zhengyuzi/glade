var Wt=Object.defineProperty;var Xt=(y,a,s)=>a in y?Wt(y,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):y[a]=s;var E=(y,a,s)=>Xt(y,typeof a!="symbol"?a+"":a,s);import{c as ie,g as Ht,G as ye,a as Vt}from"./core-D8doS_A8.js";function Kt(y){const a=[];for(let s=0;s<y.length;s+=2)a.push({x:y[s],y:y[s+1]});return a}const Qt={sceneFunc(y,a){y.save(),y.lineCap="round",y.lineJoin="round";const s=a.points();jt(y,s),y.strokeShape(a),y.restore()}};function jt(y,a){const s=Kt(a);if(y.beginPath(),s.length>=2){const f=Jt(s,2);y.moveTo(f[0].x,f[0].y);for(let v=0;v<f.length-1;v++){const p=f[Math.max(v-1,0)],w=f[v],x=f[v+1],S=f[Math.min(v+2,f.length-1)];for(let N=0;N<=1;N+=.05){const P=qt(p,w,x,S,N);y.lineTo(P.x,P.y)}}}else{const f=s.length-1;y.lineTo(s[f].x,s[f].y)}}function Jt(y,a=2){if(y.length<=a)return y;const s=[];for(let f=0;f<y.length;f++){let v=0,p=0,w=0;for(let x=-a;x<=a;x++){const S=f+x;S>=0&&S<y.length&&(v+=y[S].x,p+=y[S].y,w++)}s.push({x:v/w,y:p/w})}return s}function qt(y,a,s,f,v){const p=v*v,w=p*v;return{x:.5*(2*a.x+(-y.x+s.x)*v+(2*y.x-5*a.x+4*s.x-f.x)*p+(-y.x+3*a.x-3*s.x+f.x)*w),y:.5*(2*a.y+(-y.y+s.y)*v+(2*y.y-5*a.y+4*s.y-f.y)*p+(-y.y+3*a.y-3*s.y+f.y)*w)}}const Ue={default:Qt};class fn{constructor(a,s={}){E(this,"name","glade-plugin-brush");E(this,"isEnable",!1);E(this,"_config",{brushType:"default",stroke:"#000000",strokeWidth:8,opacity:1});E(this,"currentLine");E(this,"lastPosition");E(this,"handleBrush",a=>{this.workspace.getFlattenedNodes([a]).forEach(f=>{if(f.className==="GladeLine"){const v=f.getAttr("brushType");f.setAttrs({sceneFunc:Ue[v||"default"].sceneFunc})}})});E(this,"handleNodeLoad",a=>a.nodes.forEach(this.handleBrush));E(this,"handlePointerdown",a=>{if(a.evt.button!==0||(this.lastPosition=this.workspace.pointerPosition||void 0,!this.lastPosition))return;const{brushType:s,strokeWidth:f,stroke:v,opacity:p}=this._config;this.currentLine=this.workspace.createNode("GladeLine",{brushType:s,strokeWidth:f,stroke:v,opacity:p,points:[this.lastPosition.x,this.lastPosition.y],sceneFunc:Ue[s].sceneFunc}),this.workspace.addNode(this.currentLine),document.addEventListener("pointermove",this.handlePointermove),document.addEventListener("pointerup",this.handlePointerup)});E(this,"handlePointermove",a=>{if(!this.currentLine||!this.lastPosition)return;const s={x:(a.x-this.workspace.x)/this.workspace.zoom,y:(a.y-this.workspace.y)/this.workspace.zoom};this.currentLine.points([...this.currentLine.points(),s.x,s.y]),this.lastPosition=s});E(this,"handlePointerup",()=>{this.currentLine=void 0,document.removeEventListener("pointermove",this.handlePointermove),document.removeEventListener("pointerup",this.handlePointerup)});E(this,"handleContextmenu",a=>a.preventDefault());this.workspace=a;const{enable:f=!1,config:v}=s;v&&(this._config={...this._config,...v}),a.nodes.forEach(this.handleBrush),f&&this.enable(),this.workspace.on("node:load",this.handleNodeLoad)}config(a){return a&&(this._config={...this._config,...a}),this._config}enable(){this.isEnable||(this.isEnable=!0,this.workspace.cursor="crosshair",this.workspace.addEventListener("pointerdown",this.handlePointerdown),this.workspace.container.addEventListener("contextmenu",this.handleContextmenu))}disable(){this.isEnable&&(this.workspace.cursor="default",this.workspace.removeEventListener("pointerdown",this.handlePointerdown),this.workspace.container.removeEventListener("contextmenu",this.handleContextmenu),this.isEnable=!1)}destroy(){this.workspace.off("node:load",this.handleNodeLoad),this.disable()}}class ln{constructor(a,s={}){E(this,"name","glade-plugin-drag-pan");E(this,"isEnable",!1);E(this,"handleContextmenu",a=>a.preventDefault());E(this,"handlePointerdown",()=>{this.workspace.cursor="grabbing",document.addEventListener("pointermove",this.handlePointermove),document.addEventListener("pointerup",this.handlePointerup)});E(this,"handlePointermove",a=>{const s=a.movementX,f=a.movementY;this.workspace.position={x:this.workspace.x+s,y:this.workspace.y+f}});E(this,"handlePointerup",()=>{this.workspace.cursor="grab",document.removeEventListener("pointermove",this.handlePointermove),document.removeEventListener("pointerup",this.handlePointerup)});this.workspace=a;const{enable:f=!1}=s;f&&this.enable()}destroy(){this.disable()}enable(){this.isEnable||(this.isEnable=!0,this.workspace.cursor="grab",this.workspace.addEventListener("pointerdown",this.handlePointerdown),this.workspace.container.addEventListener("contextmenu",this.handleContextmenu))}disable(){this.isEnable&&(this.isEnable=!1,this.workspace.cursor="default",this.workspace.removeEventListener("pointerdown",this.handlePointerdown),document.removeEventListener("pointermove",this.handlePointermove),document.removeEventListener("pointerup",this.handlePointerup),this.workspace.container.removeEventListener("contextmenu",this.handleContextmenu))}}class dn{constructor(a,s={}){E(this,"name","glade-plugin-grid-background");E(this,"isEnable",!1);E(this,"grid");E(this,"size");E(this,"borderColor");E(this,"createGrid",()=>{this.grid.clear();const{width:a,height:s,x:f,y:v,zoom:p}=this.workspace,w=this.size*p,x=Math.ceil(a/w),S=Math.ceil(s/w),N=f%w,P=v%w,m=N-w,_=P-w;for(let R=0;R<=x;R++){const A=R*w+N,O=Math.round(A-f)%(w*5)===0;if(p<.5&&!O)continue;const B=this.workspace.createNode("GladeLine",{points:[Math.floor(A)+.5,Math.floor(_)+.5,Math.floor(A)+.5,Math.floor(s-_)+.5],stroke:this.borderColor,strokeWidth:1,listening:!1,dash:O?[]:[3,3]});this.grid.add(B)}for(let R=0;R<=S;R++){const A=R*w+P,O=Math.round(A-v)%(w*5)===0;if(p<.5&&!O)continue;const B=this.workspace.createNode("GladeLine",{points:[Math.floor(m)+.5,Math.floor(A)+.5,Math.floor(a-m)+.5,Math.floor(A)+.5],stroke:this.borderColor,strokeWidth:1,listening:!1,dash:O?[]:[3,3]});this.grid.add(B)}});this.workspace=a;const{size:f=20,borderColor:v="#e9e9e9",enable:p=!1}=s;this.size=f,this.borderColor=v,this.grid=this.workspace.createNode("GladeGroup"),this.workspace.addNode(this.grid,{layer:"background"}),this.workspace.sendNodeToBack(this.grid),p&&this.enable()}destroy(){this.disable(),this.workspace.removeNode(this.grid)}enable(){this.isEnable||(this.isEnable=!0,this.createGrid(),this.workspace.on("view:update",this.createGrid))}disable(){this.isEnable&&(this.grid.clear(),this.workspace.off("view:update",this.createGrid),this.isEnable=!1)}}function ae(y){throw new Error('Could not dynamically require "'+y+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var be={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/var Ge;function Zt(){return Ge||(Ge=1,function(y,a){(function(s){y.exports=s()})(function(){return function s(f,v,p){function w(N,P){if(!v[N]){if(!f[N]){var m=typeof ae=="function"&&ae;if(!P&&m)return m(N,!0);if(x)return x(N,!0);var _=new Error("Cannot find module '"+N+"'");throw _.code="MODULE_NOT_FOUND",_}var R=v[N]={exports:{}};f[N][0].call(R.exports,function(A){var O=f[N][1][A];return w(O||A)},R,R.exports,s,f,v,p)}return v[N].exports}for(var x=typeof ae=="function"&&ae,S=0;S<p.length;S++)w(p[S]);return w}({1:[function(s,f,v){(function(p){var w=p.MutationObserver||p.WebKitMutationObserver,x;if(w){var S=0,N=new w(A),P=p.document.createTextNode("");N.observe(P,{characterData:!0}),x=function(){P.data=S=++S%2}}else if(!p.setImmediate&&typeof p.MessageChannel<"u"){var m=new p.MessageChannel;m.port1.onmessage=A,x=function(){m.port2.postMessage(0)}}else"document"in p&&"onreadystatechange"in p.document.createElement("script")?x=function(){var B=p.document.createElement("script");B.onreadystatechange=function(){A(),B.onreadystatechange=null,B.parentNode.removeChild(B),B=null},p.document.documentElement.appendChild(B)}:x=function(){setTimeout(A,0)};var _,R=[];function A(){_=!0;for(var B,X,z=R.length;z;){for(X=R,R=[],B=-1;++B<z;)X[B]();z=R.length}_=!1}f.exports=O;function O(B){R.push(B)===1&&!_&&x()}}).call(this,typeof ie<"u"?ie:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(s,f,v){var p=s(1);function w(){}var x={},S=["REJECTED"],N=["FULFILLED"],P=["PENDING"];f.exports=m;function m(g){if(typeof g!="function")throw new TypeError("resolver must be a function");this.state=P,this.queue=[],this.outcome=void 0,g!==w&&O(this,g)}m.prototype.catch=function(g){return this.then(null,g)},m.prototype.then=function(g,k){if(typeof g!="function"&&this.state===N||typeof k!="function"&&this.state===S)return this;var L=new this.constructor(w);if(this.state!==P){var C=this.state===N?g:k;R(L,C,this.outcome)}else this.queue.push(new _(L,g,k));return L};function _(g,k,L){this.promise=g,typeof k=="function"&&(this.onFulfilled=k,this.callFulfilled=this.otherCallFulfilled),typeof L=="function"&&(this.onRejected=L,this.callRejected=this.otherCallRejected)}_.prototype.callFulfilled=function(g){x.resolve(this.promise,g)},_.prototype.otherCallFulfilled=function(g){R(this.promise,this.onFulfilled,g)},_.prototype.callRejected=function(g){x.reject(this.promise,g)},_.prototype.otherCallRejected=function(g){R(this.promise,this.onRejected,g)};function R(g,k,L){p(function(){var C;try{C=k(L)}catch(Y){return x.reject(g,Y)}C===g?x.reject(g,new TypeError("Cannot resolve promise with itself")):x.resolve(g,C)})}x.resolve=function(g,k){var L=B(A,k);if(L.status==="error")return x.reject(g,L.value);var C=L.value;if(C)O(g,C);else{g.state=N,g.outcome=k;for(var Y=-1,U=g.queue.length;++Y<U;)g.queue[Y].callFulfilled(k)}return g},x.reject=function(g,k){g.state=S,g.outcome=k;for(var L=-1,C=g.queue.length;++L<C;)g.queue[L].callRejected(k);return g};function A(g){var k=g&&g.then;if(g&&(typeof g=="object"||typeof g=="function")&&typeof k=="function")return function(){k.apply(g,arguments)}}function O(g,k){var L=!1;function C($){L||(L=!0,x.reject(g,$))}function Y($){L||(L=!0,x.resolve(g,$))}function U(){k(Y,C)}var G=B(U);G.status==="error"&&C(G.value)}function B(g,k){var L={};try{L.value=g(k),L.status="success"}catch(C){L.status="error",L.value=C}return L}m.resolve=X;function X(g){return g instanceof this?g:x.resolve(new this(w),g)}m.reject=z;function z(g){var k=new this(w);return x.reject(k,g)}m.all=se;function se(g){var k=this;if(Object.prototype.toString.call(g)!=="[object Array]")return this.reject(new TypeError("must be an array"));var L=g.length,C=!1;if(!L)return this.resolve([]);for(var Y=new Array(L),U=0,G=-1,$=new this(w);++G<L;)H(g[G],G);return $;function H(Z,ne){k.resolve(Z).then(ce,function(J){C||(C=!0,x.reject($,J))});function ce(J){Y[ne]=J,++U===L&&!C&&(C=!0,x.resolve($,Y))}}}m.race=j;function j(g){var k=this;if(Object.prototype.toString.call(g)!=="[object Array]")return this.reject(new TypeError("must be an array"));var L=g.length,C=!1;if(!L)return this.resolve([]);for(var Y=-1,U=new this(w);++Y<L;)G(g[Y]);return U;function G($){k.resolve($).then(function(H){C||(C=!0,x.resolve(U,H))},function(H){C||(C=!0,x.reject(U,H))})}}},{1:1}],3:[function(s,f,v){(function(p){typeof p.Promise!="function"&&(p.Promise=s(2))}).call(this,typeof ie<"u"?ie:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(s,f,v){var p=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function w(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function x(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var S=x();function N(){try{if(!S||!S.open)return!1;var e=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),n=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!e||n)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function P(e,n){e=e||[],n=n||{};try{return new Blob(e,n)}catch(r){if(r.name!=="TypeError")throw r;for(var t=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,o=new t,i=0;i<e.length;i+=1)o.append(e[i]);return o.getBlob(n.type)}}typeof Promise>"u"&&s(3);var m=Promise;function _(e,n){n&&e.then(function(t){n(null,t)},function(t){n(t)})}function R(e,n,t){typeof n=="function"&&e.then(n),typeof t=="function"&&e.catch(t)}function A(e){return typeof e!="string"&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function O(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var B="local-forage-detect-blob-support",X=void 0,z={},se=Object.prototype.toString,j="readonly",g="readwrite";function k(e){for(var n=e.length,t=new ArrayBuffer(n),o=new Uint8Array(t),i=0;i<n;i++)o[i]=e.charCodeAt(i);return t}function L(e){return new m(function(n){var t=e.transaction(B,g),o=P([""]);t.objectStore(B).put(o,"key"),t.onabort=function(i){i.preventDefault(),i.stopPropagation(),n(!1)},t.oncomplete=function(){var i=navigator.userAgent.match(/Chrome\/(\d+)/),r=navigator.userAgent.match(/Edge\//);n(r||!i||parseInt(i[1],10)>=43)}}).catch(function(){return!1})}function C(e){return typeof X=="boolean"?m.resolve(X):L(e).then(function(n){return X=n,X})}function Y(e){var n=z[e.name],t={};t.promise=new m(function(o,i){t.resolve=o,t.reject=i}),n.deferredOperations.push(t),n.dbReady?n.dbReady=n.dbReady.then(function(){return t.promise}):n.dbReady=t.promise}function U(e){var n=z[e.name],t=n.deferredOperations.pop();if(t)return t.resolve(),t.promise}function G(e,n){var t=z[e.name],o=t.deferredOperations.pop();if(o)return o.reject(n),o.promise}function $(e,n){return new m(function(t,o){if(z[e.name]=z[e.name]||Ee(),e.db)if(n)Y(e),e.db.close();else return t(e.db);var i=[e.name];n&&i.push(e.version);var r=S.open.apply(S,i);n&&(r.onupgradeneeded=function(c){var u=r.result;try{u.createObjectStore(e.storeName),c.oldVersion<=1&&u.createObjectStore(B)}catch(l){if(l.name==="ConstraintError")console.warn('The database "'+e.name+'" has been upgraded from version '+c.oldVersion+" to version "+c.newVersion+', but the storage "'+e.storeName+'" already exists.');else throw l}}),r.onerror=function(c){c.preventDefault(),o(r.error)},r.onsuccess=function(){var c=r.result;c.onversionchange=function(u){u.target.close()},t(c),U(e)}})}function H(e){return $(e,!1)}function Z(e){return $(e,!0)}function ne(e,n){if(!e.db)return!0;var t=!e.db.objectStoreNames.contains(e.storeName),o=e.version<e.db.version,i=e.version>e.db.version;if(o&&(e.version!==n&&console.warn('The database "'+e.name+`" can't be downgraded from version `+e.db.version+" to version "+e.version+"."),e.version=e.db.version),i||t){if(t){var r=e.db.version+1;r>e.version&&(e.version=r)}return!0}return!1}function ce(e){return new m(function(n,t){var o=new FileReader;o.onerror=t,o.onloadend=function(i){var r=btoa(i.target.result||"");n({__local_forage_encoded_blob:!0,data:r,type:e.type})},o.readAsBinaryString(e)})}function J(e){var n=k(atob(e.data));return P([n],{type:e.type})}function we(e){return e&&e.__local_forage_encoded_blob}function Xe(e){var n=this,t=n._initReady().then(function(){var o=z[n._dbInfo.name];if(o&&o.dbReady)return o.dbReady});return R(t,e,e),t}function He(e){Y(e);for(var n=z[e.name],t=n.forages,o=0;o<t.length;o++){var i=t[o];i._dbInfo.db&&(i._dbInfo.db.close(),i._dbInfo.db=null)}return e.db=null,H(e).then(function(r){return e.db=r,ne(e)?Z(e):r}).then(function(r){e.db=n.db=r;for(var c=0;c<t.length;c++)t[c]._dbInfo.db=r}).catch(function(r){throw G(e,r),r})}function V(e,n,t,o){o===void 0&&(o=1);try{var i=e.db.transaction(e.storeName,n);t(null,i)}catch(r){if(o>0&&(!e.db||r.name==="InvalidStateError"||r.name==="NotFoundError"))return m.resolve().then(function(){if(!e.db||r.name==="NotFoundError"&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),Z(e)}).then(function(){return He(e).then(function(){V(e,n,t,o-1)})}).catch(t);t(r)}}function Ee(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function Ve(e){var n=this,t={db:null};if(e)for(var o in e)t[o]=e[o];var i=z[t.name];i||(i=Ee(),z[t.name]=i),i.forages.push(n),n._initReady||(n._initReady=n.ready,n.ready=Xe);var r=[];function c(){return m.resolve()}for(var u=0;u<i.forages.length;u++){var l=i.forages[u];l!==n&&r.push(l._initReady().catch(c))}var d=i.forages.slice(0);return m.all(r).then(function(){return t.db=i.db,H(t)}).then(function(h){return t.db=h,ne(t,n._defaultConfig.version)?Z(t):h}).then(function(h){t.db=i.db=h,n._dbInfo=t;for(var b=0;b<d.length;b++){var I=d[b];I!==n&&(I._dbInfo.db=t.db,I._dbInfo.version=t.version)}})}function Ke(e,n){var t=this;e=A(e);var o=new m(function(i,r){t.ready().then(function(){V(t._dbInfo,j,function(c,u){if(c)return r(c);try{var l=u.objectStore(t._dbInfo.storeName),d=l.get(e);d.onsuccess=function(){var h=d.result;h===void 0&&(h=null),we(h)&&(h=J(h)),i(h)},d.onerror=function(){r(d.error)}}catch(h){r(h)}})}).catch(r)});return _(o,n),o}function Qe(e,n){var t=this,o=new m(function(i,r){t.ready().then(function(){V(t._dbInfo,j,function(c,u){if(c)return r(c);try{var l=u.objectStore(t._dbInfo.storeName),d=l.openCursor(),h=1;d.onsuccess=function(){var b=d.result;if(b){var I=b.value;we(I)&&(I=J(I));var T=e(I,b.key,h++);T!==void 0?i(T):b.continue()}else i()},d.onerror=function(){r(d.error)}}catch(b){r(b)}})}).catch(r)});return _(o,n),o}function je(e,n,t){var o=this;e=A(e);var i=new m(function(r,c){var u;o.ready().then(function(){return u=o._dbInfo,se.call(n)==="[object Blob]"?C(u.db).then(function(l){return l?n:ce(n)}):n}).then(function(l){V(o._dbInfo,g,function(d,h){if(d)return c(d);try{var b=h.objectStore(o._dbInfo.storeName);l===null&&(l=void 0);var I=b.put(l,e);h.oncomplete=function(){l===void 0&&(l=null),r(l)},h.onabort=h.onerror=function(){var T=I.error?I.error:I.transaction.error;c(T)}}catch(T){c(T)}})}).catch(c)});return _(i,t),i}function Je(e,n){var t=this;e=A(e);var o=new m(function(i,r){t.ready().then(function(){V(t._dbInfo,g,function(c,u){if(c)return r(c);try{var l=u.objectStore(t._dbInfo.storeName),d=l.delete(e);u.oncomplete=function(){i()},u.onerror=function(){r(d.error)},u.onabort=function(){var h=d.error?d.error:d.transaction.error;r(h)}}catch(h){r(h)}})}).catch(r)});return _(o,n),o}function qe(e){var n=this,t=new m(function(o,i){n.ready().then(function(){V(n._dbInfo,g,function(r,c){if(r)return i(r);try{var u=c.objectStore(n._dbInfo.storeName),l=u.clear();c.oncomplete=function(){o()},c.onabort=c.onerror=function(){var d=l.error?l.error:l.transaction.error;i(d)}}catch(d){i(d)}})}).catch(i)});return _(t,e),t}function Ze(e){var n=this,t=new m(function(o,i){n.ready().then(function(){V(n._dbInfo,j,function(r,c){if(r)return i(r);try{var u=c.objectStore(n._dbInfo.storeName),l=u.count();l.onsuccess=function(){o(l.result)},l.onerror=function(){i(l.error)}}catch(d){i(d)}})}).catch(i)});return _(t,e),t}function et(e,n){var t=this,o=new m(function(i,r){if(e<0){i(null);return}t.ready().then(function(){V(t._dbInfo,j,function(c,u){if(c)return r(c);try{var l=u.objectStore(t._dbInfo.storeName),d=!1,h=l.openKeyCursor();h.onsuccess=function(){var b=h.result;if(!b){i(null);return}e===0||d?i(b.key):(d=!0,b.advance(e))},h.onerror=function(){r(h.error)}}catch(b){r(b)}})}).catch(r)});return _(o,n),o}function tt(e){var n=this,t=new m(function(o,i){n.ready().then(function(){V(n._dbInfo,j,function(r,c){if(r)return i(r);try{var u=c.objectStore(n._dbInfo.storeName),l=u.openKeyCursor(),d=[];l.onsuccess=function(){var h=l.result;if(!h){o(d);return}d.push(h.key),h.continue()},l.onerror=function(){i(l.error)}}catch(h){i(h)}})}).catch(i)});return _(t,e),t}function nt(e,n){n=O.apply(this,arguments);var t=this.config();e=typeof e!="function"&&e||{},e.name||(e.name=e.name||t.name,e.storeName=e.storeName||t.storeName);var o=this,i;if(!e.name)i=m.reject("Invalid arguments");else{var r=e.name===t.name&&o._dbInfo.db,c=r?m.resolve(o._dbInfo.db):H(e).then(function(u){var l=z[e.name],d=l.forages;l.db=u;for(var h=0;h<d.length;h++)d[h]._dbInfo.db=u;return u});e.storeName?i=c.then(function(u){if(u.objectStoreNames.contains(e.storeName)){var l=u.version+1;Y(e);var d=z[e.name],h=d.forages;u.close();for(var b=0;b<h.length;b++){var I=h[b];I._dbInfo.db=null,I._dbInfo.version=l}var T=new m(function(D,F){var M=S.open(e.name,l);M.onerror=function(W){var te=M.result;te.close(),F(W)},M.onupgradeneeded=function(){var W=M.result;W.deleteObjectStore(e.storeName)},M.onsuccess=function(){var W=M.result;W.close(),D(W)}});return T.then(function(D){d.db=D;for(var F=0;F<h.length;F++){var M=h[F];M._dbInfo.db=D,U(M._dbInfo)}}).catch(function(D){throw(G(e,D)||m.resolve()).catch(function(){}),D})}}):i=c.then(function(u){Y(e);var l=z[e.name],d=l.forages;u.close();for(var h=0;h<d.length;h++){var b=d[h];b._dbInfo.db=null}var I=new m(function(T,D){var F=S.deleteDatabase(e.name);F.onerror=function(){var M=F.result;M&&M.close(),D(F.error)},F.onblocked=function(){console.warn('dropInstance blocked for database "'+e.name+'" until all open connections are closed')},F.onsuccess=function(){var M=F.result;M&&M.close(),T(M)}});return I.then(function(T){l.db=T;for(var D=0;D<d.length;D++){var F=d[D];U(F._dbInfo)}}).catch(function(T){throw(G(e,T)||m.resolve()).catch(function(){}),T})})}return _(i,n),i}var rt={_driver:"asyncStorage",_initStorage:Ve,_support:N(),iterate:Qe,getItem:Ke,setItem:je,removeItem:Je,clear:qe,length:Ze,key:et,keys:tt,dropInstance:nt};function ot(){return typeof openDatabase=="function"}var K="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",it="~~local_forage_type~",_e=/^~~local_forage_type~([^~]+)~/,re="__lfsc__:",ue=re.length,fe="arbf",le="blob",xe="si08",Se="ui08",Ie="uic8",Le="si16",Ne="si32",Pe="ur16",Re="ui32",ke="fl32",Te="fl64",Ae=ue+fe.length,De=Object.prototype.toString;function Ce(e){var n=e.length*.75,t=e.length,o,i=0,r,c,u,l;e[e.length-1]==="="&&(n--,e[e.length-2]==="="&&n--);var d=new ArrayBuffer(n),h=new Uint8Array(d);for(o=0;o<t;o+=4)r=K.indexOf(e[o]),c=K.indexOf(e[o+1]),u=K.indexOf(e[o+2]),l=K.indexOf(e[o+3]),h[i++]=r<<2|c>>4,h[i++]=(c&15)<<4|u>>2,h[i++]=(u&3)<<6|l&63;return d}function de(e){var n=new Uint8Array(e),t="",o;for(o=0;o<n.length;o+=3)t+=K[n[o]>>2],t+=K[(n[o]&3)<<4|n[o+1]>>4],t+=K[(n[o+1]&15)<<2|n[o+2]>>6],t+=K[n[o+2]&63];return n.length%3===2?t=t.substring(0,t.length-1)+"=":n.length%3===1&&(t=t.substring(0,t.length-2)+"=="),t}function at(e,n){var t="";if(e&&(t=De.call(e)),e&&(t==="[object ArrayBuffer]"||e.buffer&&De.call(e.buffer)==="[object ArrayBuffer]")){var o,i=re;e instanceof ArrayBuffer?(o=e,i+=fe):(o=e.buffer,t==="[object Int8Array]"?i+=xe:t==="[object Uint8Array]"?i+=Se:t==="[object Uint8ClampedArray]"?i+=Ie:t==="[object Int16Array]"?i+=Le:t==="[object Uint16Array]"?i+=Pe:t==="[object Int32Array]"?i+=Ne:t==="[object Uint32Array]"?i+=Re:t==="[object Float32Array]"?i+=ke:t==="[object Float64Array]"?i+=Te:n(new Error("Failed to get type for BinaryArray"))),n(i+de(o))}else if(t==="[object Blob]"){var r=new FileReader;r.onload=function(){var c=it+e.type+"~"+de(this.result);n(re+le+c)},r.readAsArrayBuffer(e)}else try{n(JSON.stringify(e))}catch(c){console.error("Couldn't convert value into a JSON string: ",e),n(null,c)}}function st(e){if(e.substring(0,ue)!==re)return JSON.parse(e);var n=e.substring(Ae),t=e.substring(ue,Ae),o;if(t===le&&_e.test(n)){var i=n.match(_e);o=i[1],n=n.substring(i[0].length)}var r=Ce(n);switch(t){case fe:return r;case le:return P([r],{type:o});case xe:return new Int8Array(r);case Se:return new Uint8Array(r);case Ie:return new Uint8ClampedArray(r);case Le:return new Int16Array(r);case Pe:return new Uint16Array(r);case Ne:return new Int32Array(r);case Re:return new Uint32Array(r);case ke:return new Float32Array(r);case Te:return new Float64Array(r);default:throw new Error("Unkown type: "+t)}}var he={serialize:at,deserialize:st,stringToBuffer:Ce,bufferToString:de};function Be(e,n,t,o){e.executeSql("CREATE TABLE IF NOT EXISTS "+n.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],t,o)}function ct(e){var n=this,t={db:null};if(e)for(var o in e)t[o]=typeof e[o]!="string"?e[o].toString():e[o];var i=new m(function(r,c){try{t.db=openDatabase(t.name,String(t.version),t.description,t.size)}catch(u){return c(u)}t.db.transaction(function(u){Be(u,t,function(){n._dbInfo=t,r()},function(l,d){c(d)})},c)});return t.serializer=he,i}function Q(e,n,t,o,i,r){e.executeSql(t,o,i,function(c,u){u.code===u.SYNTAX_ERR?c.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[n.storeName],function(l,d){d.rows.length?r(l,u):Be(l,n,function(){l.executeSql(t,o,i,r)},r)},r):r(c,u)},r)}function ut(e,n){var t=this;e=A(e);var o=new m(function(i,r){t.ready().then(function(){var c=t._dbInfo;c.db.transaction(function(u){Q(u,c,"SELECT * FROM "+c.storeName+" WHERE key = ? LIMIT 1",[e],function(l,d){var h=d.rows.length?d.rows.item(0).value:null;h&&(h=c.serializer.deserialize(h)),i(h)},function(l,d){r(d)})})}).catch(r)});return _(o,n),o}function ft(e,n){var t=this,o=new m(function(i,r){t.ready().then(function(){var c=t._dbInfo;c.db.transaction(function(u){Q(u,c,"SELECT * FROM "+c.storeName,[],function(l,d){for(var h=d.rows,b=h.length,I=0;I<b;I++){var T=h.item(I),D=T.value;if(D&&(D=c.serializer.deserialize(D)),D=e(D,T.key,I+1),D!==void 0){i(D);return}}i()},function(l,d){r(d)})})}).catch(r)});return _(o,n),o}function Oe(e,n,t,o){var i=this;e=A(e);var r=new m(function(c,u){i.ready().then(function(){n===void 0&&(n=null);var l=n,d=i._dbInfo;d.serializer.serialize(n,function(h,b){b?u(b):d.db.transaction(function(I){Q(I,d,"INSERT OR REPLACE INTO "+d.storeName+" (key, value) VALUES (?, ?)",[e,h],function(){c(l)},function(T,D){u(D)})},function(I){if(I.code===I.QUOTA_ERR){if(o>0){c(Oe.apply(i,[e,l,t,o-1]));return}u(I)}})})}).catch(u)});return _(r,t),r}function lt(e,n,t){return Oe.apply(this,[e,n,t,1])}function dt(e,n){var t=this;e=A(e);var o=new m(function(i,r){t.ready().then(function(){var c=t._dbInfo;c.db.transaction(function(u){Q(u,c,"DELETE FROM "+c.storeName+" WHERE key = ?",[e],function(){i()},function(l,d){r(d)})})}).catch(r)});return _(o,n),o}function ht(e){var n=this,t=new m(function(o,i){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(c){Q(c,r,"DELETE FROM "+r.storeName,[],function(){o()},function(u,l){i(l)})})}).catch(i)});return _(t,e),t}function vt(e){var n=this,t=new m(function(o,i){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(c){Q(c,r,"SELECT COUNT(key) as c FROM "+r.storeName,[],function(u,l){var d=l.rows.item(0).c;o(d)},function(u,l){i(l)})})}).catch(i)});return _(t,e),t}function mt(e,n){var t=this,o=new m(function(i,r){t.ready().then(function(){var c=t._dbInfo;c.db.transaction(function(u){Q(u,c,"SELECT key FROM "+c.storeName+" WHERE id = ? LIMIT 1",[e+1],function(l,d){var h=d.rows.length?d.rows.item(0).key:null;i(h)},function(l,d){r(d)})})}).catch(r)});return _(o,n),o}function pt(e){var n=this,t=new m(function(o,i){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(c){Q(c,r,"SELECT key FROM "+r.storeName,[],function(u,l){for(var d=[],h=0;h<l.rows.length;h++)d.push(l.rows.item(h).key);o(d)},function(u,l){i(l)})})}).catch(i)});return _(t,e),t}function gt(e){return new m(function(n,t){e.transaction(function(o){o.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(i,r){for(var c=[],u=0;u<r.rows.length;u++)c.push(r.rows.item(u).name);n({db:e,storeNames:c})},function(i,r){t(r)})},function(o){t(o)})})}function yt(e,n){n=O.apply(this,arguments);var t=this.config();e=typeof e!="function"&&e||{},e.name||(e.name=e.name||t.name,e.storeName=e.storeName||t.storeName);var o=this,i;return e.name?i=new m(function(r){var c;e.name===t.name?c=o._dbInfo.db:c=openDatabase(e.name,"","",0),e.storeName?r({db:c,storeNames:[e.storeName]}):r(gt(c))}).then(function(r){return new m(function(c,u){r.db.transaction(function(l){function d(T){return new m(function(D,F){l.executeSql("DROP TABLE IF EXISTS "+T,[],function(){D()},function(M,W){F(W)})})}for(var h=[],b=0,I=r.storeNames.length;b<I;b++)h.push(d(r.storeNames[b]));m.all(h).then(function(){c()}).catch(function(T){u(T)})},function(l){u(l)})})}):i=m.reject("Invalid arguments"),_(i,n),i}var bt={_driver:"webSQLStorage",_initStorage:ct,_support:ot(),iterate:ft,getItem:ut,setItem:lt,removeItem:dt,clear:ht,length:vt,key:mt,keys:pt,dropInstance:yt};function wt(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function Me(e,n){var t=e.name+"/";return e.storeName!==n.storeName&&(t+=e.storeName+"/"),t}function Et(){var e="_localforage_support_test";try{return localStorage.setItem(e,!0),localStorage.removeItem(e),!1}catch{return!0}}function _t(){return!Et()||localStorage.length>0}function xt(e){var n=this,t={};if(e)for(var o in e)t[o]=e[o];return t.keyPrefix=Me(e,n._defaultConfig),_t()?(n._dbInfo=t,t.serializer=he,m.resolve()):m.reject()}function St(e){var n=this,t=n.ready().then(function(){for(var o=n._dbInfo.keyPrefix,i=localStorage.length-1;i>=0;i--){var r=localStorage.key(i);r.indexOf(o)===0&&localStorage.removeItem(r)}});return _(t,e),t}function It(e,n){var t=this;e=A(e);var o=t.ready().then(function(){var i=t._dbInfo,r=localStorage.getItem(i.keyPrefix+e);return r&&(r=i.serializer.deserialize(r)),r});return _(o,n),o}function Lt(e,n){var t=this,o=t.ready().then(function(){for(var i=t._dbInfo,r=i.keyPrefix,c=r.length,u=localStorage.length,l=1,d=0;d<u;d++){var h=localStorage.key(d);if(h.indexOf(r)===0){var b=localStorage.getItem(h);if(b&&(b=i.serializer.deserialize(b)),b=e(b,h.substring(c),l++),b!==void 0)return b}}});return _(o,n),o}function Nt(e,n){var t=this,o=t.ready().then(function(){var i=t._dbInfo,r;try{r=localStorage.key(e)}catch{r=null}return r&&(r=r.substring(i.keyPrefix.length)),r});return _(o,n),o}function Pt(e){var n=this,t=n.ready().then(function(){for(var o=n._dbInfo,i=localStorage.length,r=[],c=0;c<i;c++){var u=localStorage.key(c);u.indexOf(o.keyPrefix)===0&&r.push(u.substring(o.keyPrefix.length))}return r});return _(t,e),t}function Rt(e){var n=this,t=n.keys().then(function(o){return o.length});return _(t,e),t}function kt(e,n){var t=this;e=A(e);var o=t.ready().then(function(){var i=t._dbInfo;localStorage.removeItem(i.keyPrefix+e)});return _(o,n),o}function Tt(e,n,t){var o=this;e=A(e);var i=o.ready().then(function(){n===void 0&&(n=null);var r=n;return new m(function(c,u){var l=o._dbInfo;l.serializer.serialize(n,function(d,h){if(h)u(h);else try{localStorage.setItem(l.keyPrefix+e,d),c(r)}catch(b){(b.name==="QuotaExceededError"||b.name==="NS_ERROR_DOM_QUOTA_REACHED")&&u(b),u(b)}})})});return _(i,t),i}function At(e,n){if(n=O.apply(this,arguments),e=typeof e!="function"&&e||{},!e.name){var t=this.config();e.name=e.name||t.name,e.storeName=e.storeName||t.storeName}var o=this,i;return e.name?i=new m(function(r){e.storeName?r(Me(e,o._defaultConfig)):r(e.name+"/")}).then(function(r){for(var c=localStorage.length-1;c>=0;c--){var u=localStorage.key(c);u.indexOf(r)===0&&localStorage.removeItem(u)}}):i=m.reject("Invalid arguments"),_(i,n),i}var Dt={_driver:"localStorageWrapper",_initStorage:xt,_support:wt(),iterate:Lt,getItem:It,setItem:Tt,removeItem:kt,clear:St,length:Rt,key:Nt,keys:Pt,dropInstance:At},Ct=function(n,t){return n===t||typeof n=="number"&&typeof t=="number"&&isNaN(n)&&isNaN(t)},Bt=function(n,t){for(var o=n.length,i=0;i<o;){if(Ct(n[i],t))return!0;i++}return!1},Fe=Array.isArray||function(e){return Object.prototype.toString.call(e)==="[object Array]"},ee={},ze={},q={INDEXEDDB:rt,WEBSQL:bt,LOCALSTORAGE:Dt},Ot=[q.INDEXEDDB._driver,q.WEBSQL._driver,q.LOCALSTORAGE._driver],oe=["dropInstance"],ve=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(oe),Mt={description:"",driver:Ot.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function Ft(e,n){e[n]=function(){var t=arguments;return e.ready().then(function(){return e[n].apply(e,t)})}}function me(){for(var e=1;e<arguments.length;e++){var n=arguments[e];if(n)for(var t in n)n.hasOwnProperty(t)&&(Fe(n[t])?arguments[0][t]=n[t].slice():arguments[0][t]=n[t])}return arguments[0]}var zt=function(){function e(n){w(this,e);for(var t in q)if(q.hasOwnProperty(t)){var o=q[t],i=o._driver;this[t]=i,ee[i]||this.defineDriver(o)}this._defaultConfig=me({},Mt),this._config=me({},this._defaultConfig,n),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return e.prototype.config=function(t){if((typeof t>"u"?"undefined":p(t))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var o in t){if(o==="storeName"&&(t[o]=t[o].replace(/\W/g,"_")),o==="version"&&typeof t[o]!="number")return new Error("Database version must be a number.");this._config[o]=t[o]}return"driver"in t&&t.driver?this.setDriver(this._config.driver):!0}else return typeof t=="string"?this._config[t]:this._config},e.prototype.defineDriver=function(t,o,i){var r=new m(function(c,u){try{var l=t._driver,d=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!t._driver){u(d);return}for(var h=ve.concat("_initStorage"),b=0,I=h.length;b<I;b++){var T=h[b],D=!Bt(oe,T);if((D||t[T])&&typeof t[T]!="function"){u(d);return}}var F=function(){for(var te=function(Gt){return function(){var $t=new Error("Method "+Gt+" is not implemented by the current driver"),Ye=m.reject($t);return _(Ye,arguments[arguments.length-1]),Ye}},pe=0,Ut=oe.length;pe<Ut;pe++){var ge=oe[pe];t[ge]||(t[ge]=te(ge))}};F();var M=function(te){ee[l]&&console.info("Redefining LocalForage driver: "+l),ee[l]=t,ze[l]=te,c()};"_support"in t?t._support&&typeof t._support=="function"?t._support().then(M,u):M(!!t._support):M(!0)}catch(W){u(W)}});return R(r,o,i),r},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(t,o,i){var r=ee[t]?m.resolve(ee[t]):m.reject(new Error("Driver not found."));return R(r,o,i),r},e.prototype.getSerializer=function(t){var o=m.resolve(he);return R(o,t),o},e.prototype.ready=function(t){var o=this,i=o._driverSet.then(function(){return o._ready===null&&(o._ready=o._initDriver()),o._ready});return R(i,t,t),i},e.prototype.setDriver=function(t,o,i){var r=this;Fe(t)||(t=[t]);var c=this._getSupportedDrivers(t);function u(){r._config.driver=r.driver()}function l(b){return r._extend(b),u(),r._ready=r._initStorage(r._config),r._ready}function d(b){return function(){var I=0;function T(){for(;I<b.length;){var D=b[I];return I++,r._dbInfo=null,r._ready=null,r.getDriver(D).then(l).catch(T)}u();var F=new Error("No available storage method found.");return r._driverSet=m.reject(F),r._driverSet}return T()}}var h=this._driverSet!==null?this._driverSet.catch(function(){return m.resolve()}):m.resolve();return this._driverSet=h.then(function(){var b=c[0];return r._dbInfo=null,r._ready=null,r.getDriver(b).then(function(I){r._driver=I._driver,u(),r._wrapLibraryMethodsWithReady(),r._initDriver=d(c)})}).catch(function(){u();var b=new Error("No available storage method found.");return r._driverSet=m.reject(b),r._driverSet}),R(this._driverSet,o,i),this._driverSet},e.prototype.supports=function(t){return!!ze[t]},e.prototype._extend=function(t){me(this,t)},e.prototype._getSupportedDrivers=function(t){for(var o=[],i=0,r=t.length;i<r;i++){var c=t[i];this.supports(c)&&o.push(c)}return o},e.prototype._wrapLibraryMethodsWithReady=function(){for(var t=0,o=ve.length;t<o;t++)Ft(this,ve[t])},e.prototype.createInstance=function(t){return new e(t)},e}(),Yt=new zt;f.exports=Yt},{3:3}]},{},[4])(4)})}(be)),be.exports}var en=Zt();const tn=Ht(en);class hn{constructor(a,s={}){E(this,"name","glade-plugin-image-store");E(this,"isEnable",!1);E(this,"store");E(this,"init",async()=>{try{this.workspace.getFlattenedNodes(this.workspace.nodes).forEach(async s=>s instanceof ye&&await this.saveImage(s))}catch(a){console.error("Initialization failed:",a)}});E(this,"saveImage",async a=>{try{const s=a.imageId,f=await this.store.getItem(s);if(f){const v=new Image;v.src=f,a.image(v)}else{const v=a.dataURL;v&&await this.store.setItem(s,v)}}catch(s){console.error("Error saving image:",s)}});E(this,"deleteImage",async a=>{try{await this.store.getItem(a)&&await this.store.removeItem(a)}catch(s){console.error("Error deleting image:",s)}});E(this,"handleNodeAdd",async a=>{for(const s of a.nodes)s instanceof ye&&await this.saveImage(s)});E(this,"check",async()=>{const a=await this.store.keys(),s=this.workspace.getFlattenedNodes(this.workspace.nodes);for(const f of a)s.some(p=>p instanceof ye&&p.imageId===f)||await this.deleteImage(f)});this.workspace=a;const{enable:f=!1}=s;this.store=tn.createInstance({name:"GladeImageStore"}),f&&this.enable()}async enable(){this.isEnable||(this.isEnable=!0,await this.init(),await this.check(),this.workspace.on("node:add",this.handleNodeAdd),this.workspace.on("node:load",this.handleNodeAdd))}disable(){this.isEnable&&(this.workspace.off("node:add",this.handleNodeAdd),this.workspace.off("node:load",this.handleNodeAdd),this.isEnable=!1)}destroy(){this.disable()}}function nn(y,a,{signal:s,edges:f}={}){let v,p=null;const w=f!=null&&f.includes("leading"),x=f==null||f.includes("trailing"),S=()=>{p!==null&&(y.apply(v,p),v=void 0,p=null)},N=()=>{x&&S(),R()};let P=null;const m=()=>{P!=null&&clearTimeout(P),P=setTimeout(()=>{P=null,N()},a)},_=()=>{P!==null&&(clearTimeout(P),P=null)},R=()=>{_(),v=void 0,p=null},A=()=>{_(),S()},O=function(...B){if(s!=null&&s.aborted)return;v=this,p=B;const X=P==null;m(),w&&X&&S()};return O.schedule=m,O.cancel=R,O.flush=A,s==null||s.addEventListener("abort",R,{once:!0}),O}function $e(y,a,{signal:s,edges:f=["leading","trailing"]}={}){let v=null;const p=nn(y,a,{signal:s,edges:f}),w=function(...x){v==null?v=Date.now():Date.now()-v>=a&&(v=Date.now(),p.cancel(),p(...x)),p(...x)};return w.cancel=p.cancel,w.flush=p.flush,w}class vn{constructor(a,s={}){E(this,"name","glade-plugin-resize-observer");E(this,"isEnable",!1);E(this,"resizeObserver");this.workspace=a;const{enable:f=!1}=s;this.resizeObserver=new ResizeObserver($e(v=>{const p=v[0].contentRect;a.size=p},80)),f&&this.enable()}enable(){this.isEnable||(this.isEnable=!0,this.resizeObserver.observe(this.workspace.container))}disable(){this.isEnable&&(this.isEnable=!1,this.resizeObserver.unobserve(this.workspace.container))}destroy(){this.resizeObserver.disconnect(),this.disable()}}class mn{constructor(a,s={}){E(this,"name","glade-plugin-selection");E(this,"isEnable",!1);E(this,"isSelecting",!1);E(this,"selection");E(this,"startPosition",{x:0,y:0});E(this,"handleMouseover",()=>{this.isSelecting||(this.workspace.cursor="move",this.workspace.addEventListener("mouseout",this.handleMouseout,{onlyNode:!0}))});E(this,"handleMouseout",()=>{this.workspace.cursor="default",this.workspace.removeEventListener("mouseout",this.handleMouseout,{onlyNode:!0})});E(this,"handlePointerdownNode",a=>{const s=this.workspace.getIntersection(a.evt);this.workspace.selectNode(s||[])});E(this,"handlePointerdown",a=>{var f;const s=this.workspace.fixedPointerPosition;!s||(f=this.workspace.getIntersection(s))!=null&&f.length||(this.startPosition.x=s.x,this.startPosition.y=s.y,this.isSelecting=!0,this.workspace.selectNode([]),a.evt.button===0&&(document.addEventListener("pointermove",this.handlePointermove,!1),document.addEventListener("pointerup",this.handlePointerup,!1)))});E(this,"handlePointermove",a=>{if(!this.isSelecting)return;this.workspace.cursor="default";const{left:s,top:f}=this.workspace.container.getBoundingClientRect(),{x:v,y:p}=this.startPosition,w=a.clientX-s,x=a.clientY-f;this.selection.setAttrs({visible:!0,x:Math.min(v,w),y:Math.min(p,x),width:Math.abs(w-v),height:Math.abs(x-p)}),this.checkAndSelect()});E(this,"handlePointerup",()=>{this.isSelecting=!1,this.workspace.cursor="default",this.selection.setAttrs({visible:!1}),document.removeEventListener("pointermove",this.handlePointermove,!1),document.removeEventListener("pointerup",this.handlePointerup,!1)});E(this,"checkAndSelect",$e(()=>{if(!this.workspace.nodes.length)return;const a=this.selection.getClientRect(),s=this.workspace.nodes.filter(f=>{if(f instanceof Vt){const v=f.points(),w=f.getAbsoluteTransform().getMatrix();return on(a,v,w)}return rn(a,f.getClientRect())});s.length&&this.workspace.selectNode(s)},80));this.workspace=a;const{enable:f=!1,backgroundColor:v="rgba(107, 114, 128, 0.1)",borderColor:p="rgb(107, 114, 128)"}=s;this.selection=this.workspace.createNode("GladeRect",{fill:v,stroke:p,strokeWidth:1,visible:!1,listening:!1}),this.workspace.addNode(this.selection,{layer:"foreground"}),f&&this.enable()}enable(){this.isEnable||(this.isEnable=!0,this.workspace.cursor="default",this.workspace.addEventListener("pointerdown",this.handlePointerdown),this.workspace.addEventListener("mouseover",this.handleMouseover,{onlyNode:!0}),this.workspace.addEventListener("pointerdown",this.handlePointerdownNode,{onlyNode:!0}))}disable(){this.isEnable&&(this.workspace.removeEventListener("pointerdown",this.handlePointerdown),this.workspace.removeEventListener("mouseover",this.handleMouseover,{onlyNode:!0}),this.workspace.removeEventListener("mouseout",this.handleMouseout,{onlyNode:!0}),this.workspace.removeEventListener("pointerdown",this.handlePointerdownNode,{onlyNode:!0}),document.removeEventListener("pointermove",this.handlePointermove,!1),document.removeEventListener("pointerup",this.handlePointerup,!1),this.isEnable=!1)}destroy(){this.disable()}}function rn(y,a){const s=y.x,f=y.x+y.width,v=y.y,p=y.y+y.height,w=a.x,x=a.x+a.width,S=a.y,N=a.y+a.height;return w>=s&&x<=f&&S>=v&&N<=p}function on(y,a,s){const f=y.x,v=y.x+y.width,p=y.y,w=y.y+y.height,x=4;for(let S=0;S<a.length;S+=2*x){const N=a[S],P=a[S+1],m=s[0]*N+s[2]*P+s[4],_=s[1]*N+s[3]*P+s[5];if(m<f||m>v||_<p||_>w)return!1}return!0}class pn{constructor(a,s={}){E(this,"name","glade-plugin-text");E(this,"isEnable",!1);E(this,"_config",{fill:"#000000",fontSize:30,fontFamily:"Arial, sans-serif",opacity:1});E(this,"editable");E(this,"currentPosition",null);E(this,"handleContextmenu",a=>a.preventDefault());E(this,"handleMousedown",a=>{if(this.editable)return;this.currentPosition=this.workspace.pointerPosition;const{fontSize:s,fontFamily:f,fill:v,opacity:p}=this._config;this.editable=an({text:"",x:a.evt.x,y:a.evt.y,fontSize:s*this.workspace.zoom,fontFamily:f,maxHeight:this.workspace.height-a.evt.y,maxWidth:this.workspace.width-a.evt.x,color:v,opacity:p}),this.workspace.container.appendChild(this.editable),setTimeout(()=>{var w;return(w=this.editable)==null?void 0:w.focus()},0),this.editable.addEventListener("input",this.handleEditableInput),this.editable.addEventListener("blur",this.handleEditableBlur)});E(this,"editableBlur",()=>{var a,s;(a=this.editable)==null||a.blur(),(s=this.editable)==null||s.removeEventListener("input",this.handleEditableInput),this.workspace.removeEventListener("mousedown",this.editableBlur)});E(this,"handleEditableBlur",()=>{if(this.editable){if(this.workspace.container.removeChild(this.editable),this.editable.value.trim()){const{fontSize:a,fontFamily:s,fill:f,opacity:v}=this._config,{x:p,y:w}=this.currentPosition,x=this.workspace.createNode("GladeText",{x:p,y:w,text:this.editable.value,fontSize:a,fontFamily:s,opacity:v,fill:f});this.workspace.addNode(x)}this.editable.removeEventListener("blur",this.handleEditableBlur),this.editable=void 0,this.currentPosition=null}});E(this,"handleEditableInput",()=>{if(this.editable){const{fontSize:a}=this._config,s=this.editable.value,{width:f,height:v}=We(s,a*this.workspace.zoom);this.editable.style.width=`${f}px`,this.editable.style.height=`${v}px`}});this.workspace=a;const{enable:f=!1,config:v}=s;v&&(this._config={...this._config,...v}),f&&this.enable()}enable(){this.isEnable||(this.isEnable=!0,this.workspace.cursor="text",this.workspace.addEventListener("mousedown",this.handleMousedown),this.workspace.container.addEventListener("contextmenu",this.handleContextmenu))}disable(){var a,s;this.isEnable&&(this.workspace.cursor="default",this.workspace.removeEventListener("mousedown",this.handleMousedown),this.workspace.container.removeEventListener("contextmenu",this.handleContextmenu),(a=this.editable)==null||a.removeEventListener("input",this.handleEditableInput),(s=this.editable)==null||s.removeEventListener("blur",this.handleEditableBlur),this.workspace.removeEventListener("mousedown",this.editableBlur),this.isEnable=!1)}destroy(){this.disable(),this.editable=void 0,this.currentPosition=null}config(a){return a&&(this._config={...this._config,...a}),this._config}}function an(y){const{x:a,y:s,fontSize:f,fontFamily:v,text:p,maxHeight:w,maxWidth:x,color:S,opacity:N}=y,P=document.createElement("textarea");P.value=p;const{width:m,height:_}=We(p,f);return Object.assign(P.style,{position:"absolute",left:`${a}px`,top:`${s}px`,height:`${_}`,maxHeight:`${w}px`,lineHeight:`${f}px`,width:`${m}px`,maxWidth:`${x}px`,fontSize:`${f}px`,color:S,opacity:N,display:"inline-block",fontFamily:v,margin:0,padding:0,border:0,outline:0,resize:"none",background:"transparent",overflow:"hidden",boxSizing:"content-box",whiteSpace:"pre",wordBreak:"normal"}),P}function We(y="",a){const s=y.split(`
`);return{width:s.reduce((v,p)=>Math.max(v,p.length),0)*a||a,height:s.length*a||a}}export{vn as G,mn as a,hn as b,dn as c,ln as d,fn as e,pn as f};
